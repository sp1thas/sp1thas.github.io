<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Semi-Supervised Fraud Detection | Panagiotis Simakis</title>
  <meta name="description" content="Hi there ðŸ‘‹ and welcome to my personal website. I&#39;m a Software Engineer, passionate with NLP and GNU/Linux addict. Data Engineering is my reality.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Semi-Supervised Fraud Detection" />
<meta property="og:description" content="A jupyter notebook about semi-supervised fraud detection." />
<meta property="og:type" content="article" />
<meta property="og:url" content="sp1thas.github.io/posts/semi-supervised-fraud-detection/" />
<meta property="article:published_time" content="2020-03-30T15:24:09+02:00" />
<meta property="article:modified_time" content="2020-03-30T15:24:09+02:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Semi-Supervised Fraud Detection"/>
<meta name="twitter:description" content="A jupyter notebook about semi-supervised fraud detection."/>

  
  
    
  
  
  <link rel="stylesheet" href="sp1thas.github.io/css/style-classic.css">
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="sp1thas.github.io/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="sp1thas.github.io/">Home</a></li>
         
        <li><a href="sp1thas.github.io/posts">Writings</a></li>
         
        <li><a href="sp1thas.github.io/tags">Tags</a></li>
         
        <li><a href="sp1thas.github.io/simakis_cv.pdf">RÃ©sumÃ© ðŸ’¾</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" sp1thas.github.io/posts/introduction-to-book-depository-dataset/">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="sp1thas.github.io/posts/scrapy-store-images-efficiently-using-folder-structure/">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&text=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&title=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&is_video=false&description=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Semi-Supervised%20Fraud%20Detection&body=Check out this article: sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&title=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&title=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&title=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-stumbleupon " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&title=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-digg " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&name=Semi-Supervised%20Fraud%20Detection&description=A%20jupyter%20notebook%20about%20semi-supervised%20fraud%20detection.">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&t=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#intro">Intro</a>
      <ul>
        <li><a href="#isolation-forest">Isolation Forest</a></li>
        <li><a href="#one-class-svm-ocsvm">One Class SVM (OCSVM)</a></li>
        <li><a href="#autoencoders">Autoencoders</a></li>
      </ul>
    </li>
    <li><a href="#implementation">Implementation</a>
      <ul>
        <li><a href="#dataset">Dataset</a></li>
        <li><a href="#preprocessing">Preprocessing</a></li>
        <li><a href="#training">Training</a></li>
        <li><a href="#enseble">Enseble</a>
          <ul>
            <li><a href="#hard-voting">Hard Voting</a></li>
            <li><a href="#weighted-hard-voting">Weighted Hard Voting</a></li>
            <li><a href="#blending">Blending</a></li>
          </ul>
        </li>
        <li><a href="#evaluation">Evaluation</a></li>
      </ul>
    </li>
    <li><a href="#future-work">Future Work</a></li>
    <li><a href="#resources">Resources</a></li>
  </ul>
</nav>
    </div>
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Semi-Supervised Fraud Detection
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2020-03-30 15:24:09 &#43;0200 &#43;0200" itemprop="datePublished">2020-03-30</time>
          
        </div>
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/sp1thas.github.io/tags/python" rel="tag">python</a>
            
             ,  
            <a class="tag-link" href="/sp1thas.github.io/tags/machine-learning" rel="tag">machine learning</a>
            
             ,  
            <a class="tag-link" href="/sp1thas.github.io/tags/deep-learning" rel="tag">deep learning</a>
            
        </div>
        
      </div>
    </header>

  
    <div class="content" itemprop="articleBody">
      <h2 id="intro">Intro</h2>
<p><strong>dataset:</strong> <a href="https://www.kaggle.com/mlg-ulb/creditcardfraud">Credit Card Fraud Detection</a></p>
<p><strong>kaggle notebook:</strong> <a href="https://www.kaggle.com/sp1thas/semi-supervised-fraud-detection">Semi-Supervised Fraud Detection</a></p>
<p>keywords: <code>fraud detection</code>, <code>novelty detection</code>, <code>ensembling</code>, <code>learning representation</code>, <code>semi-supervised learning</code></p>
<p>Usually, datasets related to fraud detection are highly unbalanced due to the fact that, in the of transactions, only few of then are fraudulent. Instead of trying to augment the dataset using a resample method, we are going to approach this problem as a Novelty Detection problem.</p>
<p>On this kernel, we are goind describe the dataset briefly and then, we will compare multiple machine learning algorithms using some evaluation metrics.</p>
<p>Most common machine learning algorithms for this kind of tasks are the following:</p>
<ol>
<li>Isolation forest</li>
<li>One class SVM</li>
<li>Autoencoders</li>
</ol>
<h3 id="isolation-forest">Isolation Forest</h3>
<p><img src="https://i.imgur.com/rzP7siS.png" alt="isolation-tree"></p>
<p><a href="https://blog.easysol.net/using-isolation-forests-anamoly-detection/">source</a></p>
<blockquote>
<p>The Isolation Forest algorithm isolates observations by randomly selecting a feature and then randomly selecting a split value between the maximum and minimum values of the selected feature. The logic argument goes: isolating anomaly observations is easier because only a few conditions are needed to separate those cases from the normal observations. On the other hand, isolating normal observations require more conditions. Therefore, an anomaly score can be calculated as the number of conditions required to separate a given observation.</p>
</blockquote>
<h3 id="one-class-svm-ocsvm">One Class SVM (OCSVM)</h3>
<p><img src="https://ars.els-cdn.com/content/image/1-s2.0-S0031320314002751-gr6.jpg" alt=""></p>
<p><a href="https://towardsdatascience.com/outlier-detection-with-one-class-svms-5403a1a1878c">source</a></p>
<blockquote>
<p>A One-Class Support Vector Machine is an unsupervised learning algorithm that is trained only on the â€˜normalâ€™ data, in our case the negative examples. It learns the boundaries of these points and is therefore able to classify any points that lie outside the boundary as, you guessed it, outliers.</p>
</blockquote>
<h3 id="autoencoders">Autoencoders</h3>
<p><a href="https://www.deeplearningbook.org/contents/autoencoders.html">source</a></p>
<blockquote>
<p>An autoencoder is a neural network that is trained to attempt to copy its input to its output. Internally, it has a hidden layer h that describes a code used to represent the input. The network may be viewed as consisting of two parts: an encoder function <code>h = f (x)</code> and a decoder that produces a reconstruction <code>r = g(h)</code>.</p>
</blockquote>
<p><img src="https://miro.medium.com/max/3524/1*oUbsOnYKX5DEpMOK3pH_lg.png" alt="autoencoder"></p>
<p>In our case, we will train the autoencoder using samples of normal transactions only. After that, we will provide a fraudulent sample as input to the model. As a result, the representation should have larger loss error. Therefore, by defining a loss threashold, this ANN model will work as novelty detection model.</p>
<h2 id="implementation">Implementation</h2>
<p><img src="https://i.imgur.com/Y8FWKqi.png" alt="implementation"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd

<span style="color:#f92672">from</span> sklearn.ensemble <span style="color:#f92672">import</span> IsolationForest
<span style="color:#f92672">from</span> sklearn.svm <span style="color:#f92672">import</span> OneClassSVM
<span style="color:#f92672">from</span> sklearn.preprocessing <span style="color:#f92672">import</span> StandardScaler
<span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> train_test_split
<span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> confusion_matrix, recall_score, f1_score, accuracy_score, precision_score
<span style="color:#f92672">from</span> sklearn.ensemble <span style="color:#f92672">import</span> VotingClassifier, RandomForestClassifier
<span style="color:#f92672">from</span> sklearn.decomposition <span style="color:#f92672">import</span> PCA, IncrementalPCA, LatentDirichletAllocation
<span style="color:#f92672">from</span> sklearn.manifold <span style="color:#f92672">import</span> TSNE

<span style="color:#f92672">from</span> tqdm.notebook <span style="color:#f92672">import</span> tqdm, trange
<span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> NoReturn, Union, List
<span style="color:#f92672">from</span> mlxtend.classifier <span style="color:#f92672">import</span> EnsembleVoteClassifier
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">import</span> seaborn <span style="color:#f92672">as</span> sns
<span style="color:#f92672">import</span> tensorflow <span style="color:#f92672">as</span> tf
<span style="color:#f92672">from</span> umap <span style="color:#f92672">import</span> UMAP
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;../input/creditcardfraud/creditcard.csv&#39;</span>)
df<span style="color:#f92672">.</span>head()
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Time</th>
      <th>V1</th>
      <th>V2</th>
      <th>V3</th>
      <th>V4</th>
      <th>V5</th>
      <th>V6</th>
      <th>V7</th>
      <th>V8</th>
      <th>V9</th>
      <th>...</th>
      <th>V21</th>
      <th>V22</th>
      <th>V23</th>
      <th>V24</th>
      <th>V25</th>
      <th>V26</th>
      <th>V27</th>
      <th>V28</th>
      <th>Amount</th>
      <th>Class</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.0</td>
      <td>-1.359807</td>
      <td>-0.072781</td>
      <td>2.536347</td>
      <td>1.378155</td>
      <td>-0.338321</td>
      <td>0.462388</td>
      <td>0.239599</td>
      <td>0.098698</td>
      <td>0.363787</td>
      <td>...</td>
      <td>-0.018307</td>
      <td>0.277838</td>
      <td>-0.110474</td>
      <td>0.066928</td>
      <td>0.128539</td>
      <td>-0.189115</td>
      <td>0.133558</td>
      <td>-0.021053</td>
      <td>149.62</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.0</td>
      <td>1.191857</td>
      <td>0.266151</td>
      <td>0.166480</td>
      <td>0.448154</td>
      <td>0.060018</td>
      <td>-0.082361</td>
      <td>-0.078803</td>
      <td>0.085102</td>
      <td>-0.255425</td>
      <td>...</td>
      <td>-0.225775</td>
      <td>-0.638672</td>
      <td>0.101288</td>
      <td>-0.339846</td>
      <td>0.167170</td>
      <td>0.125895</td>
      <td>-0.008983</td>
      <td>0.014724</td>
      <td>2.69</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.0</td>
      <td>-1.358354</td>
      <td>-1.340163</td>
      <td>1.773209</td>
      <td>0.379780</td>
      <td>-0.503198</td>
      <td>1.800499</td>
      <td>0.791461</td>
      <td>0.247676</td>
      <td>-1.514654</td>
      <td>...</td>
      <td>0.247998</td>
      <td>0.771679</td>
      <td>0.909412</td>
      <td>-0.689281</td>
      <td>-0.327642</td>
      <td>-0.139097</td>
      <td>-0.055353</td>
      <td>-0.059752</td>
      <td>378.66</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.0</td>
      <td>-0.966272</td>
      <td>-0.185226</td>
      <td>1.792993</td>
      <td>-0.863291</td>
      <td>-0.010309</td>
      <td>1.247203</td>
      <td>0.237609</td>
      <td>0.377436</td>
      <td>-1.387024</td>
      <td>...</td>
      <td>-0.108300</td>
      <td>0.005274</td>
      <td>-0.190321</td>
      <td>-1.175575</td>
      <td>0.647376</td>
      <td>-0.221929</td>
      <td>0.062723</td>
      <td>0.061458</td>
      <td>123.50</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2.0</td>
      <td>-1.158233</td>
      <td>0.877737</td>
      <td>1.548718</td>
      <td>0.403034</td>
      <td>-0.407193</td>
      <td>0.095921</td>
      <td>0.592941</td>
      <td>-0.270533</td>
      <td>0.817739</td>
      <td>...</td>
      <td>-0.009431</td>
      <td>0.798278</td>
      <td>-0.137458</td>
      <td>0.141267</td>
      <td>-0.206010</td>
      <td>0.502292</td>
      <td>0.219422</td>
      <td>0.215153</td>
      <td>69.99</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>5 rows Ã— 31 columns</p>
</div>


<h3 id="dataset">Dataset</h3>
<ul>
<li><code>V{1-28}</code>: <code>PCA</code> decompossition outcome</li>
<li><code>Class</code> label (0: normal, 1: fraudulent)</li>
<li><code>Time</code>: Number of seconds elapsed between this transaction and the first transaction in the dataset</li>
<li><code>Amount</code>: transaction amount</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># use a dataset sample for development purposes</span>
dev <span style="color:#f92672">=</span> False
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df<span style="color:#f92672">.</span>groupby([<span style="color:#e6db74">&#39;Class&#39;</span>])<span style="color:#f92672">.</span>Class<span style="color:#f92672">.</span>count()<span style="color:#f92672">.</span>plot(kind<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;pie&#39;</span>, title<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Fraudulent VS Genuine Transactions&#39;</span>)
</code></pre></div><pre><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f5dca0a79d0&gt;
</code></pre>
<p><img src="semi-supervised-fraud-detection_files/semi-supervised-fraud-detection_6_1.png" alt="png"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">df_s <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>sample(<span style="color:#ae81ff">2000</span>)
X <span style="color:#f92672">=</span> df_s[[_ <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> df<span style="color:#f92672">.</span>columns <span style="color:#66d9ef">if</span> _ <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;Class&#39;</span>]]

pca <span style="color:#f92672">=</span> PCA(n_components<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
tsne <span style="color:#f92672">=</span> TSNE(n_components<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
ump <span style="color:#f92672">=</span> UMAP(n_components<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
ipca <span style="color:#f92672">=</span> IncrementalPCA(n_components<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)

x_pca <span style="color:#f92672">=</span> pca<span style="color:#f92672">.</span>fit_transform(X)
x_tsne <span style="color:#f92672">=</span> tsne<span style="color:#f92672">.</span>fit_transform(X)
x_umap <span style="color:#f92672">=</span> ump<span style="color:#f92672">.</span>fit_transform(X)
</code></pre></div><p><code>PCA</code>, <code>UMAP</code> and <code>t-SNE</code> will be used for further dimensionality reduction in order to visualize a sample of the dataset</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">fig, axes <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(nrows<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, ncols<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">5</span>))

sizes <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Series(df_s[<span style="color:#e6db74">&#39;Class&#39;</span>]<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>pow(<span style="color:#ae81ff">5</span>) <span style="color:#75715e"># represent fraud with bigger point</span>

axes[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>scatter(x_pca[:, <span style="color:#ae81ff">0</span>], x_pca[:, <span style="color:#ae81ff">1</span>], s<span style="color:#f92672">=</span>sizes, c<span style="color:#f92672">=</span>df_s[<span style="color:#e6db74">&#39;Class&#39;</span>]<span style="color:#f92672">.</span>values)
axes[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>scatter(x_tsne[:, <span style="color:#ae81ff">0</span>], x_tsne[:, <span style="color:#ae81ff">1</span>], s<span style="color:#f92672">=</span>sizes, c<span style="color:#f92672">=</span>df_s[<span style="color:#e6db74">&#39;Class&#39;</span>]<span style="color:#f92672">.</span>values)
axes[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>scatter(x_umap[:, <span style="color:#ae81ff">0</span>], x_umap[:, <span style="color:#ae81ff">1</span>], s<span style="color:#f92672">=</span>sizes, c<span style="color:#f92672">=</span>df_s[<span style="color:#e6db74">&#39;Class&#39;</span>]<span style="color:#f92672">.</span>values)

axes[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;PCA&#39;</span>)
axes[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;t-SNE&#39;</span>)
axes[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;UMAP&#39;</span>)

fig<span style="color:#f92672">.</span>tight_layout()
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="semi-supervised-fraud-detection_files/semi-supervised-fraud-detection_9_0.png" alt="png"></p>
<h3 id="preprocessing">Preprocessing</h3>
<p><code>Time</code> and <code>Amount</code> fields should be scaled</p>
<p>During the step of pre-processing, the dataset will be splited in two parts:</p>
<ol>
<li>~283K samples of genuine transactions (Training set)</li>
<li>All fraudulent samples and equal number of genuine samples (Test set)</li>
</ol>
<p>Novelty detection is concered as a semi-supervised task due to the fact that only the normal samples are used during the phase of training. During the phase of evaluation, a balanced subset of genuine and fraudulent samples will be used.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># time and amount scaling</span>
df[<span style="color:#e6db74">&#39;Time&#39;</span>] <span style="color:#f92672">=</span> StandardScaler()<span style="color:#f92672">.</span>fit_transform(df[<span style="color:#e6db74">&#39;Time&#39;</span>]<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>))
df[<span style="color:#e6db74">&#39;Amount&#39;</span>] <span style="color:#f92672">=</span> StandardScaler()<span style="color:#f92672">.</span>fit_transform(df[<span style="color:#e6db74">&#39;Amount&#39;</span>]<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>))

df_anom <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;Class&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>]
df_norm <span style="color:#f92672">=</span> df[df[<span style="color:#e6db74">&#39;Class&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>]

<span style="color:#66d9ef">if</span> dev:
    df_norm <span style="color:#f92672">=</span> df_norm<span style="color:#f92672">.</span>sample(<span style="color:#ae81ff">5000</span>, random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">42</span>)
df_test_norm <span style="color:#f92672">=</span> df_norm<span style="color:#f92672">.</span>sample(df_anom<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>])
df_test <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>concat([
    df_anom,
    df_test_norm
])
df_train <span style="color:#f92672">=</span> df_norm<span style="color:#f92672">.</span>drop(df_test_norm<span style="color:#f92672">.</span>index)

feature_cols <span style="color:#f92672">=</span> [_ <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> df<span style="color:#f92672">.</span>columns <span style="color:#66d9ef">if</span> _ <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;Class&#39;</span>]
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">X_train <span style="color:#f92672">=</span> df_train[feature_cols]
y_train <span style="color:#f92672">=</span> df_train[<span style="color:#e6db74">&#39;Class&#39;</span>] <span style="color:#75715e"># will not be used</span>
X_test <span style="color:#f92672">=</span> df_test[feature_cols]
y_test <span style="color:#f92672">=</span> df_test[<span style="color:#e6db74">&#39;Class&#39;</span>] <span style="color:#75715e"># for evaluation</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">train: [{:&gt;8} x {:&lt;5}]
</span><span style="color:#e6db74"> test: [{:&gt;8} x {:&lt;5}]
</span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#f92672">*</span>X_train<span style="color:#f92672">.</span>shape, <span style="color:#f92672">*</span>X_test<span style="color:#f92672">.</span>shape))
</code></pre></div><pre><code>train: [  283823 x 30   ]
 test: [     984 x 30   ]
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sensitivity_keras</span>(y_true, y_pred):
    <span style="color:#e6db74">&#34;&#34;&#34;credits: https://datascience.stackexchange.com/a/40746/28592
</span><span style="color:#e6db74">    
</span><span style="color:#e6db74">    param:
</span><span style="color:#e6db74">    y_pred - Predicted labels
</span><span style="color:#e6db74">    y_true - True labels 
</span><span style="color:#e6db74">    Returns:
</span><span style="color:#e6db74">    Specificity score
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    neg_y_true <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> y_true
    neg_y_pred <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> y_pred
    fp <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>backend<span style="color:#f92672">.</span>sum(neg_y_true <span style="color:#f92672">*</span> y_pred)
    tn <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>backend<span style="color:#f92672">.</span>sum(neg_y_true <span style="color:#f92672">*</span> neg_y_pred)
    specificity <span style="color:#f92672">=</span> tn <span style="color:#f92672">/</span> (tn <span style="color:#f92672">+</span> fp <span style="color:#f92672">+</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>backend<span style="color:#f92672">.</span>epsilon())
    <span style="color:#66d9ef">return</span> specificity
</code></pre></div><h3 id="training">Training</h3>
<p>We are going to define some wrappers, these classes will work as adapters in order to have an abstract implementation.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Scaled_IsolationForest</span>(IsolationForest):
    <span style="color:#e6db74">&#34;&#34;&#34;The purpose of this sub-class is to transform prediction values from {-1, 1} to {1,0}
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">predict</span>(self, X):
        pred <span style="color:#f92672">=</span> super()<span style="color:#f92672">.</span>predict(X)
        scale_func <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>vectorize(<span style="color:#66d9ef">lambda</span> x: <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
        <span style="color:#66d9ef">return</span> scale_func(pred)

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Scaled_OneClass_SVM</span>(OneClassSVM):
    <span style="color:#e6db74">&#34;&#34;&#34;The purpose of this sub-class is to transform prediction values from {-1, 1} to {1,0}
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">predict</span>(self, X):
        <span style="color:#66d9ef">return</span> np<span style="color:#f92672">.</span>array([y<span style="color:#f92672">==-</span><span style="color:#ae81ff">1</span> <span style="color:#66d9ef">for</span> y <span style="color:#f92672">in</span> super()<span style="color:#f92672">.</span>predict(X)])
    
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NoveltyDetection_Sequential</span>(tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>models<span style="color:#f92672">.</span>Sequential):
    <span style="color:#e6db74">&#34;&#34;&#34;This custom `tf.keras.models.Sequential` sub-class transforms autoencoder&#39;s output into {1,0}.
</span><span style="color:#e6db74">    Output value is determined based on reproduction (decode) loss. If reproduction loss is more than a threashold then, the input sample is considered as anomaly (outlier).
</span><span style="color:#e6db74">    Based on few experiments, 1.5 is a dissent threashold (don&#39;t as why :P). Future work: determine the threashold using a more sophisticated method.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">predict</span>(self, x, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        pred <span style="color:#f92672">=</span> super()<span style="color:#f92672">.</span>predict(x, <span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
        mse <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(np<span style="color:#f92672">.</span>power(x <span style="color:#f92672">-</span> pred, <span style="color:#ae81ff">2</span>), axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
        scale_func <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>vectorize(<span style="color:#66d9ef">lambda</span> x: <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">if</span> x <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1.5</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">0</span>)
        <span style="color:#66d9ef">return</span> scale_func(mse)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># define early stop in order to prevent overfitting and useless training</span>
early_stop <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>callbacks<span style="color:#f92672">.</span>EarlyStopping(
    monitor<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mse&#39;</span>,
    patience<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>,
    verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, 
    mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;min&#39;</span>,
    restore_best_weights<span style="color:#f92672">=</span>True,
)

<span style="color:#75715e"># it&#39;s a common practice to store the best model</span>
checkpoint <span style="color:#f92672">=</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>callbacks<span style="color:#f92672">.</span>ModelCheckpoint(
    filepath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;autoenc.hdf5&#39;</span>,
    save_best_only<span style="color:#f92672">=</span>True,
    monitor<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;val_loss&#39;</span>,
    mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;min&#39;</span>,
    verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_autoencoder</span>() <span style="color:#f92672">-&gt;</span> tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>models<span style="color:#f92672">.</span>Sequential:
    <span style="color:#e6db74">&#34;&#34;&#34;Build an autoencoder
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    model <span style="color:#f92672">=</span> NoveltyDetection_Sequential([
        tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(X_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>], activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>, input_shape<span style="color:#f92672">=</span>(X_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>], )),
        <span style="color:#75715e"># add some noise to prevent overfitting</span>
        tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>GaussianNoise(<span style="color:#ae81ff">0.05</span>),
        tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(<span style="color:#ae81ff">2</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>),
        tf<span style="color:#f92672">.</span>keras<span style="color:#f92672">.</span>layers<span style="color:#f92672">.</span>Dense(X_train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">1</span>], activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)
    ])
    model<span style="color:#f92672">.</span>compile(optimizer<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;adam&#39;</span>, 
                        loss<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mse&#39;</span>,
                        metrics<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;acc&#39;</span>, sensitivity_keras])
    <span style="color:#66d9ef">return</span> model
</code></pre></div><p>The following dictionary containes the models and the parameters that we are going to use during the phase of training</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">clfs <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#39;isolation_forest&#39;</span>: {
        <span style="color:#e6db74">&#39;label&#39;</span>: <span style="color:#e6db74">&#39;Isolation Forest&#39;</span>,
        <span style="color:#e6db74">&#39;clb&#39;</span>: Scaled_IsolationForest,
        <span style="color:#e6db74">&#39;params&#39;</span>: {
            <span style="color:#e6db74">&#39;contamination&#39;</span>: <span style="color:#e6db74">&#39;auto&#39;</span>,
            <span style="color:#e6db74">&#39;n_estimators&#39;</span>: <span style="color:#ae81ff">300</span>
        },
        <span style="color:#e6db74">&#39;predictions&#39;</span>: None,
        <span style="color:#e6db74">&#39;model&#39;</span>: None
    },
    <span style="color:#e6db74">&#39;ocsvm&#39;</span>: {
        <span style="color:#e6db74">&#39;label&#39;</span>: <span style="color:#e6db74">&#39;OneClass SVM&#39;</span>,
        <span style="color:#e6db74">&#39;clb&#39;</span>: Scaled_OneClass_SVM,
        <span style="color:#e6db74">&#39;params&#39;</span>: {
            <span style="color:#e6db74">&#39;kernel&#39;</span>: <span style="color:#e6db74">&#39;rbf&#39;</span>,
            <span style="color:#e6db74">&#39;gamma&#39;</span>: <span style="color:#ae81ff">0.3</span>,
            <span style="color:#e6db74">&#39;nu&#39;</span>: <span style="color:#ae81ff">0.01</span>,
        },
        <span style="color:#e6db74">&#39;prediction&#39;</span>: None,
        <span style="color:#e6db74">&#39;model&#39;</span>: None
    },
    <span style="color:#e6db74">&#39;auto-encoder&#39;</span>: {
        <span style="color:#e6db74">&#39;label&#39;</span>: <span style="color:#e6db74">&#39;Autoncoder&#39;</span>,
        <span style="color:#e6db74">&#39;clb&#39;</span>: get_autoencoder,
        <span style="color:#e6db74">&#39;params&#39;</span>: {},
        <span style="color:#e6db74">&#39;fit_params&#39;</span>: {
            <span style="color:#e6db74">&#39;x&#39;</span>: X_train, <span style="color:#e6db74">&#39;y&#39;</span>: X_train,
            <span style="color:#e6db74">&#39;validation_split&#39;</span>: <span style="color:#ae81ff">0.2</span>,
            <span style="color:#e6db74">&#39;callbacks&#39;</span>: [early_stop, checkpoint],
            <span style="color:#e6db74">&#39;epochs&#39;</span>: <span style="color:#ae81ff">64</span>,
            <span style="color:#e6db74">&#39;batch_size&#39;</span>: <span style="color:#ae81ff">256</span>,
            <span style="color:#e6db74">&#39;verbose&#39;</span>: <span style="color:#ae81ff">0</span>
        },
        <span style="color:#e6db74">&#39;predictions&#39;</span>: None,
        <span style="color:#e6db74">&#39;model&#39;</span>: None
    }
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">%%</span>time

t <span style="color:#f92672">=</span> trange(len(clfs))
<span style="color:#66d9ef">for</span> name <span style="color:#f92672">in</span> clfs:
    t<span style="color:#f92672">.</span>set_description(clfs[name][<span style="color:#e6db74">&#39;label&#39;</span>])
    clfs[name][<span style="color:#e6db74">&#39;model&#39;</span>] <span style="color:#f92672">=</span> clfs[name][<span style="color:#e6db74">&#39;clb&#39;</span>](<span style="color:#f92672">**</span>clfs[name][<span style="color:#e6db74">&#39;params&#39;</span>])
    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;fit_params&#39;</span> <span style="color:#f92672">in</span> clfs[name]:
        clfs[name][<span style="color:#e6db74">&#39;model&#39;</span>]<span style="color:#f92672">.</span>fit(<span style="color:#f92672">**</span>clfs[name]<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;fit_params&#39;</span>, {}))
    <span style="color:#66d9ef">else</span>:
        clfs[name][<span style="color:#e6db74">&#39;model&#39;</span>]<span style="color:#f92672">.</span>fit(X_train)
    clfs[name][<span style="color:#e6db74">&#39;predictions&#39;</span>] <span style="color:#f92672">=</span> clfs[name][<span style="color:#e6db74">&#39;model&#39;</span>]<span style="color:#f92672">.</span>predict(X_test)
    t<span style="color:#f92672">.</span>update()
t<span style="color:#f92672">.</span>close()
</code></pre></div><pre><code>HBox(children=(FloatProgress(value=0.0, max=3.0), HTML(value='')))



CPU times: user 3h 9min 26s, sys: 38.6 s, total: 3h 10min 4s
Wall time: 3h 8min 34s
</code></pre>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">print_eval_metrics</span>(y_true, y_pred, name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>, header<span style="color:#f92672">=</span>True):
    <span style="color:#e6db74">&#34;&#34;&#34;Function for printing purposes
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">if</span> header:
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{:&gt;20}</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">{:&gt;10}</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">{:&gt;10}</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">{:&gt;8}</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">{:&gt;5}&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#e6db74">&#39;Algorith&#39;</span>, <span style="color:#e6db74">&#39;Accuracy&#39;</span>, <span style="color:#e6db74">&#39;Recall&#39;</span>, <span style="color:#e6db74">&#39;Precision&#39;</span>, <span style="color:#e6db74">&#39;f1&#39;</span>))
    acc <span style="color:#f92672">=</span> accuracy_score(y_true, y_pred)
    recall <span style="color:#f92672">=</span> recall_score(y_true, y_pred)
    prec <span style="color:#f92672">=</span> precision_score(y_true, y_pred)
    f1 <span style="color:#f92672">=</span> f1_score(y_true, y_pred)
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;{:&gt;20}</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">{:&gt;1.8f}</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">{:&gt;1.8f}</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">{:&gt;1.6f}</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">{:&gt;1.3f}&#39;</span><span style="color:#f92672">.</span>format(
        name, acc, recall, prec, f1
    ))
</code></pre></div><h3 id="enseble">Enseble</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">y_preds <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>column_stack([clfs[_][<span style="color:#e6db74">&#39;predictions&#39;</span>] <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> clfs])
enseble_preds <span style="color:#f92672">=</span> []
</code></pre></div><h4 id="hard-voting">Hard Voting</h4>
<p>This is one of the simplest way to combine multiple models in order to generalize better and achive better performance.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">hard_vot <span style="color:#f92672">=</span> EnsembleVoteClassifier([clfs[_][<span style="color:#e6db74">&#39;model&#39;</span>] <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> clfs], fit_base_estimators<span style="color:#f92672">=</span>False)
hard_vot<span style="color:#f92672">.</span>fit(X_test, y_test)
enseble_preds<span style="color:#f92672">.</span>append((hard_vot<span style="color:#f92672">.</span>predict(X_test), <span style="color:#e6db74">&#39;Hard Voting&#39;</span>))
</code></pre></div><pre><code>/opt/conda/lib/python3.7/site-packages/mlxtend/classifier/ensemble_vote.py:166: UserWarning: fit_base_estimators=False enforces use_clones to be `False`
  warnings.warn(&quot;fit_base_estimators=False &quot;
</code></pre>
<h4 id="weighted-hard-voting">Weighted Hard Voting</h4>
<p>Using weighted hard voting you can take advantage of most high-performed models</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">wei_hard_vot <span style="color:#f92672">=</span> EnsembleVoteClassifier([clfs[_][<span style="color:#e6db74">&#39;model&#39;</span>] <span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> clfs], weights<span style="color:#f92672">=</span>[
        <span style="color:#ae81ff">0.4</span>,
        <span style="color:#ae81ff">0.1</span>,
        <span style="color:#ae81ff">0.8</span>
    ], fit_base_estimators<span style="color:#f92672">=</span>False)
wei_hard_vot<span style="color:#f92672">.</span>fit(X_test, y_test)
enseble_preds<span style="color:#f92672">.</span>append((wei_hard_vot<span style="color:#f92672">.</span>predict(X_test), <span style="color:#e6db74">&#39;Weighted Hard Voting&#39;</span>))
</code></pre></div><pre><code>/opt/conda/lib/python3.7/site-packages/mlxtend/classifier/ensemble_vote.py:166: UserWarning: fit_base_estimators=False enforces use_clones to be `False`
  warnings.warn(&quot;fit_base_estimators=False &quot;
</code></pre>
<h4 id="blending">Blending</h4>
<p>We are going to use the the predicted values as input to another model</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">rf <span style="color:#f92672">=</span> RandomForestClassifier()

x_tr_ens, x_ts_ens, y_tr_ens, y_ts_ens <span style="color:#f92672">=</span> train_test_split(y_preds, y_test, test_size<span style="color:#f92672">=.</span><span style="color:#ae81ff">5</span>)
rf<span style="color:#f92672">.</span>fit(x_tr_ens, y_tr_ens)
</code></pre></div><pre><code>RandomForestClassifier()
</code></pre>
<h3 id="evaluation">Evaluation</h3>
<p>It&rsquo;s crusial to detect fraudulent transactions, therefor a significat evaluation metric could the <code>simplicity</code>. For every trained method and ensebling method the following evaluation metrics will be calculated:</p>
<ul>
<li>Accuracy</li>
<li>Recall</li>
<li>Precision</li>
<li>f1 Score</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">print_header <span style="color:#f92672">=</span> True
<span style="color:#66d9ef">for</span> k, v <span style="color:#f92672">in</span> clfs<span style="color:#f92672">.</span>items():
    print_eval_metrics(y_test, v[<span style="color:#e6db74">&#39;predictions&#39;</span>], v[<span style="color:#e6db74">&#39;label&#39;</span>], print_header)
    print_header <span style="color:#f92672">=</span> False

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)

<span style="color:#66d9ef">for</span> prds, l <span style="color:#f92672">in</span> enseble_preds:
    print_eval_metrics(y_test, prds, l, print_header)
    print_header <span style="color:#f92672">=</span> False

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
    
print_eval_metrics(
    y_ts_ens,
    rf<span style="color:#f92672">.</span>predict(x_ts_ens),
    <span style="color:#e6db74">&#39;Bleding using RF&#39;</span>, False
)
</code></pre></div><pre><code>            Algorith	  Accuracy	    Recall	Precision	   f1
    Isolation Forest	0.90040650	0.84349593	0.951835	0.894
        OneClass SVM	0.87398374	0.93699187	0.832130	0.881
          Autoncoder	0.89939024	0.87398374	0.920771	0.897


         Hard Voting	0.90548780	0.88008130	0.927195	0.903
Weighted Hard Voting	0.89939024	0.87398374	0.920771	0.897


    Bleding using RF	0.92479675	0.90909091	0.942623	0.926
</code></pre>
<h2 id="future-work">Future Work</h2>
<ul>
<li>Find the auto-encoding loss threashold using a more sophisticated way</li>
<li>Test more models and different configurations</li>
</ul>
<h2 id="resources">Resources</h2>
<ol>
<li>Outlier Detection with One-Class SVMs <a href="https://towardsdatascience.com/outlier-detection-with-one-class-svms-5403a1a1878c">url</a></li>
<li>Niu, X., Wang, L., &amp; Yang, X. (2019). A comparison study of credit card fraud detection: Supervised versus unsupervised. arXiv preprint arXiv:1904.10604. <a href="https://arxiv.org/abs/1904.10604">url</a> <a href="https://arxiv.org/pdf/1904.10604">pdf</a></li>
<li>Benefits of Anomaly Detection Using Isolation Forests <a href="https://blog.easysol.net/using-isolation-forests-anamoly-detection/">url</a></li>
<li>scikit-learn: Voting Classifier <a href="https://scikit-learn.org/stable/modules/ensemble.html#voting-classifier">url</a></li>
<li>scikit-learn: Novelty and Outlier Detection <a href="https://scikit-learn.org/stable/modules/outlier_detection.html#outlier-detection">url</a></li>
<li>Building Autoencoders in Keras <a href="https://blog.keras.io/building-autoencoders-in-keras.html">url</a></li>
<li>Goodfellow, Ian, Yoshua Bengio, and Aaron Courville. Deep learning. MIT press, 2016. <a href="https://www.deeplearningbook.org/">url</a></li>
<li>Porwal, Utkarsh, and Smruthi Mukund. &ldquo;Credit card fraud detection in e-commerce: An outlier detection approach.&rdquo; arXiv preprint arXiv:1811.02196 (2018). <a href="https://arxiv.org/abs/1811.02196">url</a></li>
</ol>

    </div>
  </article>

  
  




  
    <div class="blog-post-comments">
        <div id="disqus_thread">
          <script type="text/javascript">
          
          (function() {
              
              
              
              
          
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              var disqus_shortname = 'panagiotissimakis';
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="https://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </div>

  


  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="sp1thas.github.io/">Home</a></li>
         
          <li><a href="sp1thas.github.io/posts">Writings</a></li>
         
          <li><a href="sp1thas.github.io/tags">Tags</a></li>
         
          <li><a href="sp1thas.github.io/simakis_cv.pdf">RÃ©sumÃ© ðŸ’¾</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#intro">Intro</a>
      <ul>
        <li><a href="#isolation-forest">Isolation Forest</a></li>
        <li><a href="#one-class-svm-ocsvm">One Class SVM (OCSVM)</a></li>
        <li><a href="#autoencoders">Autoencoders</a></li>
      </ul>
    </li>
    <li><a href="#implementation">Implementation</a>
      <ul>
        <li><a href="#dataset">Dataset</a></li>
        <li><a href="#preprocessing">Preprocessing</a></li>
        <li><a href="#training">Training</a></li>
        <li><a href="#enseble">Enseble</a>
          <ul>
            <li><a href="#hard-voting">Hard Voting</a></li>
            <li><a href="#weighted-hard-voting">Weighted Hard Voting</a></li>
            <li><a href="#blending">Blending</a></li>
          </ul>
        </li>
        <li><a href="#evaluation">Evaluation</a></li>
      </ul>
    </li>
    <li><a href="#future-work">Future Work</a></li>
    <li><a href="#resources">Resources</a></li>
  </ul>
</nav>
    </div>

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&text=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&title=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&is_video=false&description=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Semi-Supervised%20Fraud%20Detection&body=Check out this article: sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&title=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&title=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&title=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&title=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-digg fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&name=Semi-Supervised%20Fraud%20Detection&description=A%20jupyter%20notebook%20about%20semi-supervised%20fraud%20detection.">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=sp1thas.github.io%2fposts%2fsemi-supervised-fraud-detection%2f&t=Semi-Supervised%20Fraud%20Detection">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  Panagiotis Simakis 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="sp1thas.github.io/">Home</a></li>
         
        <li><a href="sp1thas.github.io/posts">Writings</a></li>
         
        <li><a href="sp1thas.github.io/tags">Tags</a></li>
         
        <li><a href="sp1thas.github.io/simakis_cv.pdf">RÃ©sumÃ© ðŸ’¾</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/sp1thas.github.io/lib/font-awesome/css/all.min.css>
<script src=/sp1thas.github.io/lib/jquery/jquery.min.js></script>
<script src=/sp1thas.github.io/js/main.js></script>



</html>
